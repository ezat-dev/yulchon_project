<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="alarm">

<!-- 전송 안한 알람 조회 -->
	<select id="getAlarmList" parameterType="alarm"
		resultType="alarm">
		SELECT * FROM tb_alarmlist
		WHERE is_send = '0';
	</select>
<!-- 알람 전송됨으로 업데이트 -->
	<update id="updateAlarmSend" parameterType="alarm">
		UPDATE tb_alarmlist
		SET is_send = '1'
		WHERE regtime = #{regtime}
	</update>
	<!-- 알람 전체 조회 -->
		<select id="allAlarmList" parameterType="alarm"
		resultType="alarm">
		SELECT * FROM tb_alarm
	</select>
	<!-- 알람 그룹 업데이트 -->
<update id="updateAlarmGroup" parameterType="alarm">
    UPDATE tb_alarm
    SET 
        ${fieldName} = #{newValue}
    WHERE
        alarm_address = #{alarm_address}
</update>
	<!-- 알람 그룹 일괄 업데이트 -->
<update id="updateAllAlarmGroup" parameterType="alarm">
    UPDATE tb_alarm
    SET 
        ${fieldName} = #{newValue}
</update>

	<!-- 알람 그룹 이름 조회 -->
<select id="getAlarmGroupName" parameterType="alarm"
		resultType="alarm">
SELECT * FROM tb_alarm_group;
</select>
<!-- 알람 조회(포함하는 그룹까지) -->
	<select id="selectAlarmList" parameterType="alarm"
		resultType="alarm">
    SELECT
    a.*,
    GROUP_CONCAT(g.alarm_group_name ORDER BY g.alarm_group_name ASC SEPARATOR ', ') AS alarm_groups
FROM
    tb_alarm a
LEFT JOIN
    tb_alarm_group_mapping m ON a.alarm_address = m.alarm_address
LEFT JOIN
    tb_alarm_group g ON m.alarm_group_id = g.alarm_group_id
GROUP BY
    a.alarm_address
ORDER BY
    a.alarm_address;
	</select>
		<insert id="insertAlarmGroup" parameterType="alarm">
    INSERT INTO tb_alarm_group_mapping (
        alarm_address,
        alarm_group_id
    ) VALUES (
        #{alarm_address},
        #{alarm_group_id}
    )
</insert>
<delete id="deleteAlarmGroup" parameterType="alarm">
    DELETE FROM tb_alarm_group_mapping
    WHERE 
        alarm_address = #{alarm_address}
    AND 
        alarm_group_id = #{alarm_group_id}
</delete>
<insert id="insertAllAlarmGroup" parameterType="alarm">
    INSERT IGNORE INTO tb_alarm_group_mapping (alarm_address, alarm_group_id)
    VALUES 
    <foreach collection="alarmAddresses" item="address" separator=",">
        (#{address}, #{alarm_group_id})
    </foreach>
</insert>
<delete id="deleteAllAlarmGroup" parameterType="alarm">
    DELETE FROM tb_alarm_group_mapping
    WHERE alarm_group_id = #{alarm_group_id}
    AND alarm_address IN
    <foreach collection="alarmAddresses" item="address" open="(" close=")" separator=",">
        #{address}
    </foreach>
</delete>
	<!-- 알람 그룹 이름 업데이트 -->
<update id="updateAlarmGroupName" parameterType="alarm">
    UPDATE tb_alarm_group
    SET 
        alarm_group_name = #{alarm_group_name}
        WHERE alarm_group_id = #{alarm_group_id}
</update>
</mapper>